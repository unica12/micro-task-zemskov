#!/bin/bash
echo "=== –ü–†–û–í–ï–†–ö–ê –¢–†–ï–ë–û–í–ê–ù–ò–ô –ò–ó –¢–ó ==="
echo ""

echo "üìã –ß–ï–ö-–õ–ò–°–¢ –ò–ó –¢–ó:"
echo ""

echo "1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç"
curl -X POST http://localhost:8000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"tz_check@example.com","password":"test123","name":"–¢–ó –ü—Ä–æ–≤–µ—Ä–∫–∞"}' 2>/dev/null | grep -q '"success":true'
if [ $? -eq 0 ]; then
  echo "‚úÖ –£–°–ü–ï–•: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
  echo "‚ùå –û–®–ò–ë–ö–ê: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi
echo ""

echo "2. –í—Ö–æ–¥ –≤—ã–¥–∞—ë—Ç JWT –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –ø—Ä–æ—Ö–æ–¥—è—Ç"
LOGIN_RESPONSE=$(curl -s -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"tz_check@example.com","password":"test123"}')
if echo "$LOGIN_RESPONSE" | grep -q '"token"'; then
  echo "‚úÖ –£–°–ü–ï–•: JWT —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω"
  TOKEN=$(echo "$LOGIN_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤
  PROFILE_RESPONSE=$(curl -s -X GET http://localhost:8000/api/v1/users/me \
    -H "Authorization: Bearer $TOKEN")
  
  if echo "$PROFILE_RESPONSE" | grep -q '"success":true'; then
    echo "‚úÖ –£–°–ü–ï–•: –ó–∞—â–∏—â–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å —Ç–æ–∫–µ–Ω–æ–º"
  else
    echo "‚ùå –û–®–ò–ë–ö–ê: –ó–∞—â–∏—â–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç"
  fi
else
  echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω"
fi
echo ""

echo "3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –ø—Ä–∞–≤ –Ω–µ –≤–∏–¥–∏—Ç –∞–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏"
if [ -n "$TOKEN" ]; then
  ADMIN_LIST_RESPONSE=$(curl -s -X GET "http://localhost:8000/api/v1/users?page=1&limit=10" \
    -H "Authorization: Bearer $TOKEN")
  
  if echo "$ADMIN_LIST_RESPONSE" | grep -q '"code":"FORBIDDEN"'; then
    echo "‚úÖ –£–°–ü–ï–•: –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
  elif echo "$ADMIN_LIST_RESPONSE" | grep -q '"code":"SERVICE_UNAVAILABLE"'; then
    echo "‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (Circuit Breaker)"
  else
    echo "–û—Ç–≤–µ—Ç: $ADMIN_LIST_RESPONSE"
  fi
fi
echo ""

echo "4. –õ–æ–≥–∏ –≤–∏–¥–Ω—ã –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞"
echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤ API Gateway (–∏—â–µ–º X-Request-ID):"
docker-compose logs api_gateway --tail=3 2>/dev/null | grep -i "x-request-id\|request" || echo "   (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—Ä—É—á–Ω—É—é: docker-compose logs api_gateway)"
echo ""

echo "5. Health check —Ä–∞–±–æ—Ç–∞–µ—Ç"
HEALTH_RESPONSE=$(curl -s -X GET http://localhost:8000/health)
if echo "$HEALTH_RESPONSE" | grep -q '"success":true'; then
  echo "‚úÖ –£–°–ü–ï–•: Health check —Ä–∞–±–æ—Ç–∞–µ—Ç"
  echo "   –°—Ç–∞—Ç—É—Å: $(echo "$HEALTH_RESPONSE" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)"
else
  echo "‚ùå –û–®–ò–ë–ö–ê: Health check –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi
echo ""

echo "=== –¢–ï–°–¢–û–í–´–ï –°–¶–ï–ù–ê–†–ò–ò –ò–ó –¢–ó ==="
echo ""

echo "üéØ –ù–∞ –æ—Ü–µ–Ω–∫—É 3 (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏):"
echo "  ‚úÖ –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ –ø–æ–ª—è–º–∏"
echo "  ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å —Ç–æ–π –∂–µ –ø–æ—á—Ç–æ–π (–æ–∂–∏–¥–∞–µ–º –æ—à–∏–±–∫—É)"
echo "  ‚úÖ –í—Ö–æ–¥ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–æ–∂–∏–¥–∞–µ–º –≤—ã–¥–∞—á—É —Ç–æ–∫–µ–Ω–∞)"
echo "  ‚úÖ –î–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º—É –ø—É—Ç–∏ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–æ–∂–∏–¥–∞–µ–º –æ—Ç–∫–∞–∑)"
echo ""

echo "üéØ –ù–∞ –æ—Ü–µ–Ω–∫—É 4 (+ –ó–∞–∫–∞–∑—ã):"
echo "  ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
echo "  ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ –∑–∞–∫–∞–∑–∞"
echo "  ‚úÖ –°–ø–∏—Å–æ–∫ —Å–≤–æ–∏—Ö –∑–∞–∫–∞–∑–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π"
echo ""

echo "üéØ –ù–∞ –æ—Ü–µ–Ω–∫—É 5 (–ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª):"
echo "  üîÑ –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å —á—É–∂–æ–π –∑–∞–∫–∞–∑ (–æ–∂–∏–¥–∞–µ–º –æ—Ç–∫–∞–∑)"
echo "  üîÑ –û—Ç–º–µ–Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞"
echo ""

echo "=== –°–¢–ê–¢–£–° –†–ï–ê–õ–ò–ó–ê–¶–ò–ò ==="
echo "‚úÖ API Gateway: JWT, rate limiting, CORS, Circuit Breaker"
echo "‚úÖ Users Service: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤—Ö–æ–¥, –ø—Ä–æ—Ñ–∏–ª—å, –∞–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏"
echo "‚úÖ Orders Service: –°–æ–∑–¥–∞–Ω–∏–µ, –ø–æ–ª—É—á–µ–Ω–∏–µ, —Å—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤"
echo "‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: Pino —Å X-Request-ID –≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö"
echo "‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è"
echo "‚úÖ Docker: –¢—Ä–∏ —Å–µ—Ä–≤–∏—Å–∞ –≤ docker-compose"
echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –°–∫—Ä–∏–ø—Ç—ã –∏ Postman –∫–æ–ª–ª–µ–∫—Ü–∏—è"
echo "‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏—è: Dev –∏ Prod –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
